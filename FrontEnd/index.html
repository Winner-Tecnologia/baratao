<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barat√£o Assados - Home</title>
    <!-- Font Awesome para √≠cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts (Exemplo: Poppins) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Estilos da p√°gina -->
    <link rel="stylesheet" href="css/style_index.css">
</head>
<body>
    <header class="main-header">
        <div class="container header-content">
            <div class="logo">
                <img src="img/logo.png" alt="Barat√£o Assados Logo">
                <h1>Barat√£o Assados</h1>
            </div>
            <nav class="main-nav">
                <span class="user-welcome">Ol√°, <span>[Nome do Usu√°rio]</span>!</span>
                <button class="btn btn-logout" data-action="logout">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </nav>
        </div>
    </header>

    <main class="container main-content">
        <section class="dashboard-grid">
            <!-- Card de Status do Estabelecimento -->
            <div class="card status-card" id="status-card">
                <h2><i class="fas fa-store"></i> Status do Estabelecimento</h2>
                <p class="status-message">Verificando...</p>
                <p class="current-time"><i class="fas fa-clock"></i> <span id="current-time-display">--:--</span></p>
                <div class="available-services" id="available-services-list">
                    <!-- Servi√ßos dispon√≠veis ser√£o carregados aqui -->
                </div>
            </div>

            <!-- Card de Card√°pio & Pedidos -->
            <div class="card menu-order-card" id="menu-order-card" data-action="goToOrders">
                <h2><i class="fas fa-utensils"></i> Card√°pio & Pedidos</h2>
                <p>Explore nosso delicioso card√°pio e fa√ßa seu pedido!</p>
                <button class="btn btn-primary">Ver Card√°pio</button>
            </div>

            <!-- Card de Meus Pedidos -->
            <div class="card my-orders-card" id="my-orders-card" data-action="viewMyOrders">
                <h2><i class="fas fa-history"></i> Meus Pedidos</h2>
                <p>Acompanhe o status dos seus pedidos e veja seu hist√≥rico.</p>
                <button class="btn btn-secondary">Ver Hist√≥rico</button>
            </div>
        </section>

        <!-- Se√ß√£o de Contato -->
        <section class="contact-section">
            <h2><i class="fas fa-headset"></i> Fale Conosco</h2>
            <div class="contact-info">
                <a href="https://instagram.com/barataoassados" target="_blank" class="contact-item">
                    <i class="fab fa-instagram"></i> Instagram
                </a>
                <a href="https://wa.me/5561999999999" target="_blank" class="contact-item">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </a>
                <a href="https://maps.google.com/?q=Seu+Endere√ßo+Aqui" target="_blank" class="contact-item">
                    <i class="fas fa-map-marker-alt"></i> Localiza√ß√£o
                </a>
            </div>
        </section>
    </main>

    <!-- Modal de Estabelecimento Fechado -->
    <div id="closed-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-action="closeModal">&times;</span>
            <h2><i class="fas fa-exclamation-triangle"></i> Estamos Fechados!</h2>
            <p>No momento, o Barat√£o Assados est√° fechado para pedidos.</p>
            <p>Confira nossos hor√°rios de funcionamento:</p>
            <ul id="closed-modal-hours">
                <li><strong>Almo√ßo:</strong> Quinta, Domingo e Feriados (11:00 √†s 15:00)</li>
                <li><strong>Assados B√°sicos:</strong> Quinta e Sexta (18:00 √†s 22:00)</li>
                <li><strong>Assados Completos:</strong> S√°bado, Domingo e Feriados (18:00 √†s 22:00)</li>
                <li><strong>Jantinha:</strong> Quarta a Sexta (18:00 √†s 22:00)</li>
            </ul>
            <p>Agradecemos a compreens√£o!</p>
        </div>
    </div>

    <!-- √Årea para Notifica√ß√µes -->
    <div id="notification-container"></div>

    <!-- Scripts JavaScript -->
    <script src="js/auth.js"></script> <!-- M√≥dulo de autentica√ß√£o -->
    <script>
        /**
         * index.js - L√≥gica principal da p√°gina Home
         * Gerencia a UI, status de disponibilidade e navega√ß√£o.
         */

        // --- M√≥dulos da Aplica√ß√£o ---

        const DataModule = (() => {
            const API_BASE_URL = './api/';
            const UPDATE_TIME_INTERVAL = 30000; // 30 segundos
            const HOLIDAYS_2025 = [ // Exemplo de feriados para 2025
                '2025-01-01', // Ano Novo
                '2025-02-25', // Carnaval (ter√ßa)
                '2025-04-18', // Paix√£o de Cristo
                '2025-04-21', // Tiradentes
                '2025-05-01', // Dia do Trabalho
                '2025-06-19', // Corpus Christi
                '2025-09-07', // Independ√™ncia do Brasil
                '2025-10-12', // Nossa Senhora Aparecida
                '2025-11-02', // Finados
                '2025-11-15', // Proclama√ß√£o da Rep√∫blica
                '2025-12-25', // Natal
            ];

            return {
                API_BASE_URL,
                UPDATE_TIME_INTERVAL,
                HOLIDAYS_2025
            };
        })();

        const UtilsModule = (() => {
            const formatTime = (date) => {
                return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            };

            const formatDate = (date) => {
                return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            };

            const isTodayHoliday = (date) => {
                const today = date.toISOString().slice(0, 10); // 'YYYY-MM-DD'
                return DataModule.HOLIDAYS_2025.includes(today);
            };

            return {
                formatTime,
                formatDate,
                isTodayHoliday
            };
        })();

        const NotificationModule = (() => {
            const container = document.getElementById('notification-container');

            const showNotification = (message, type, duration = 3000) => {
                const notification = document.createElement('div');
                notification.className = notification ${type};
                notification.textContent = message;
                container.appendChild(notification);

                setTimeout(() => {
                    notification.classList.add('hide');
                    notification.addEventListener('transitionend', () => notification.remove());
                }, duration);
            };

            const success = (message, duration) => showNotification(message, 'success', duration);
            const error = (message, duration) => showNotification(message, 'error', duration);
            const info = (message, duration) => showNotification(message, 'info', duration);

            return {
                success,
                error,
                info
            };
        })();

        const NavigationModule = (() => {
            const goToLogin = () => {
                window.location.href = 'login.html';
            };

            const goToHome = () => {
                window.location.href = 'index.html';
            };

            const goToOrders = () => {
                window.location.href = 'pedidos.html'; // Assumindo que voc√™ ter√° uma p√°gina de pedidos
            };

            return {
                goToLogin,
                goToHome,
                goToOrders
            };
        })();

        const AvailabilityModule = (() => {
            let currentAvailability = {
                aberto: false,
                servicos: [],
                mensagem: 'Verificando...',
                horario_atual: '--:--',
                data: '--/--/----'
            };

            const checkAvailability = async () => {
                try {
                    const response = await fetch(${DataModule.API_BASE_URL}availability.php);
                    if (!response.ok) {
                        throw new Error('Erro ao buscar disponibilidade');
                    }
                    const data = await response.json();
                    currentAvailability = data;
                    return data;
                } catch (error) {
                    console.error('Erro ao verificar disponibilidade:', error);
                    NotificationModule.error('N√£o foi poss√≠vel verificar o status do estabelecimento.');
                    return currentAvailability; // Retorna o √∫ltimo estado conhecido ou padr√£o
                }
            };

            const getProducts = async (service = '', group = '') => {
                try {
                    const params = new URLSearchParams();
                    if (service) params.append('servico', service);
                    if (group) params.append('grupo', group);

                    const response = await fetch(${DataModule.API_BASE_URL}products.php?${params.toString()});
                    if (!response.ok) {
                        throw new Error('Erro ao buscar produtos');
                    }
                    const data = await response.json();
                    return data.produtos;
                } catch (error) {
                    console.error('Erro ao buscar produtos:', error);
                    NotificationModule.error('N√£o foi poss√≠vel carregar o card√°pio.');
                    return [];
                }
            };

            const getAvailability = () => currentAvailability;

            return {
                checkAvailability,
                getProducts,
                getAvailability
            };
        })();

        const UIModule = (() => {
            const statusCard = document.getElementById('status-card');
            const statusMessage = statusCard.querySelector('.status-message');
            const currentTimeDisplay = document.getElementById('current-time-display');
            const availableServicesList = document.getElementById('available-services-list');
            const closedModal = document.getElementById('closed-modal');
            const welcomeSpan = document.querySelector('.user-welcome span');

            const updateCurrentTime = () => {
                const now = new Date();
                currentTimeDisplay.textContent = UtilsModule.formatTime(now);
            };

            const updateAvailableServices = async () => {
                const availability = await AvailabilityModule.checkAvailability();
                
                statusMessage.textContent = availability.mensagem;
                statusCard.classList.toggle('open', availability.aberto);
                statusCard.classList.toggle('closed', !availability.aberto);

                availableServicesList.innerHTML = '';
                if (availability.aberto && availability.servicos && availability.servicos.length > 0) {
                    const ul = document.createElement('ul');
                    availability.servicos.forEach(service => {
                        const li = document.createElement('li');
                        li.textContent = service;
                        ul.appendChild(li);
                    });
                    availableServicesList.appendChild(ul);
                } else if (!availability.aberto) {
                    availableServicesList.innerHTML = '<p>Nenhum servi√ßo dispon√≠vel no momento.</p>';
                }
            };

            const updateAvailableMenus = async () => {
                // Esta fun√ß√£o pode ser expandida para mostrar pr√©vias de menus
                // Por enquanto, apenas atualiza o status geral
                const availability = AvailabilityModule.getAvailability();
                const menuOrderCard = document.getElementById('menu-order-card');
                menuOrderCard.classList.toggle('disabled', !availability.aberto);
                menuOrderCard.querySelector('button').disabled = !availability.aberto;
                menuOrderCard.querySelector('button').textContent = availability.aberto ? 'Ver Card√°pio' : 'Fechado';
            };

            const showClosedModal = () => {
                closedModal.style.display = 'block';
            };

            const hideClosedModal = () => {
                closedModal.style.display = 'none';
            };

            const setUserName = (name) => {
                if (welcomeSpan) {
                    welcomeSpan.textContent = Ol√°, ${name}!;
                }
            };

            return {
                updateCurrentTime,
                updateAvailableServices,
                updateAvailableMenus,
                showClosedModal,
                hideClosedModal,
                setUserName
            };
        })();

        const App = (() => {
            const handleGlobalClick = async (event) => {
                const action = event.target.dataset.action || event.target.closest('[data-action]')?.dataset.action;

                switch (action) {
                    case "logout":
                        try {
                            // Limpar sessionStorage
                            sessionStorage.removeItem('usuario_id');
                            sessionStorage.removeItem('usuario_nome');
                            sessionStorage.removeItem('usuario_cpf');
                            
                            // Chamar logout na API (se necess√°rio, AuthAPI deve estar dispon√≠vel)
                            if (typeof AuthAPI !== 'undefined' && AuthAPI.logout) {
                                await AuthAPI.logout();
                            }
                            
                            // Redirecionar para login
                            NotificationModule.success("Logout realizado!");
                            setTimeout(() => {
                                NavigationModule.goToLogin();
                            }, 500);
                        } catch (error) {
                            console.error('Erro no logout:', error);
                            // Mesmo com erro, limpar dados locais e redirecionar
                            sessionStorage.clear();
                            NavigationModule.goToLogin();
                        }
                        break;
                    case "goToOrders":
                        const availability = AvailabilityModule.getAvailability();
                        if (availability.aberto) {
                            NavigationModule.goToOrders();
                        } else {
                            UIModule.showClosedModal();
                        }
                        break;
                    case "viewMyOrders":
                        // Implementar navega√ß√£o para a p√°gina de hist√≥rico de pedidos
                        NotificationModule.info("Funcionalidade 'Meus Pedidos' em desenvolvimento!");
                        break;
                    case "closeModal":
                        UIModule.hideClosedModal();
                        break;
                    default:
                        // console.log("A√ß√£o n√£o reconhecida:", action);
                        break;
                }
            };

            const init = () => {
                try {
                    // VERIFICAR SE USU√ÅRIO EST√Å AUTENTICADO
                    const usuarioId = sessionStorage.getItem('usuario_id');
                    if (!usuarioId) {
                        // Redirecionar para login
                        NavigationModule.goToLogin();
                        return;
                    }

                    // Obter dados do usu√°rio
                    const usuarioNome = sessionStorage.getItem('usuario_nome');
                    UIModule.setUserName(usuarioNome || 'Visitante');
                    
                    // Renderizar interface inicial
                    UIModule.updateCurrentTime();
                    UIModule.updateAvailableServices();
                    UIModule.updateAvailableMenus();

                    // Configurar eventos globais
                    document.addEventListener("click", handleGlobalClick);

                    // Atualizar informa√ß√µes periodicamente
                    setInterval(() => {
                        UIModule.updateCurrentTime();
                        UIModule.updateAvailableServices();
                        UIModule.updateAvailableMenus();
                    }, DataModule.UPDATE_TIME_INTERVAL);

                    console.log("üöÄ P√°gina HOME inicializada com sucesso!");
                    NotificationModule.success(Bem-vindo(a) de volta, ${usuarioNome}!, 2000);

                } catch (error) {
                    console.error("‚ùå Erro na inicializa√ß√£o da HOME:", error);
                    NotificationModule.error("Erro ao carregar a p√°gina. Tente recarregar.");
                }
            };

            return {
                init
            };
        })();

        // Inicializa a aplica√ß√£o quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>