<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Cliente - Barat√£o Assados</title>
    <link rel="stylesheet" href="style_cadastro.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="background-animation"></div>

    <section class="principal">
      <!-- Header com Logo e Navega√ß√£o -->
      <div class="header-section">
        <div class="logo-container">
          <div class="logo-icon">
            <i class="fas fa-fire"></i>
          </div>
          <div class="logo-text">
            <h1>Cadastro de Cliente</h1>
            <p class="logo-subtitle">Crie sua conta no Barat√£o Assados</p>
          </div>
        </div>

        <div class="header-actions">
          <button
            class="btn-back"
            data-action="navigate-back"
            aria-label="Voltar √† p√°gina de login"
          >
            <i class="fas fa-arrow-left"></i>
            <span>Voltar</span>
          </button>
        </div>
      </div>

      <!-- Formul√°rio de Cadastro -->
      <div class="login-container">
        <div class="login-card">
          <div class="card-header">
            <h2>Bem-vindo(a)!</h2>
            <p class="subtitle">Preencha seus dados para criar sua conta.</p>
          </div>

          <form class="register-form" id="registerForm">
            <div class="form-group">
              <label for="fullName" class="form-label">Nome Completo</label>
              <div class="input-wrapper">
                <i class="fas fa-user icon-input"></i>
                <input
                  type="text"
                  id="fullName"
                  class="form-input"
                  placeholder="Seu nome completo"
                  aria-label="Nome Completo"
                  required
                />
              </div>
              <span class="form-error" id="fullNameError"></span>
            </div>

            <div class="form-group">
              <label for="address" class="form-label">Endere√ßo</label>
              <div class="input-wrapper">
                <i class="fas fa-map-marker-alt icon-input"></i>
                <input
                  type="text"
                  id="address"
                  class="form-input"
                  placeholder="Seu endere√ßo completo"
                  aria-label="Endere√ßo"
                  required
                />
              </div>
              <span class="form-error" id="addressError"></span>
            </div>

            <div class="form-group">
              <label for="cpf" class="form-label">CPF</label>
              <div class="input-wrapper">
                <i class="fas fa-id-card icon-input"></i>
                <input
                  type="text"
                  id="cpf"
                  class="form-input"
                  placeholder="000.000.000-00"
                  aria-label="CPF"
                  maxlength="14"
                  required
                />
              </div>
              <span class="form-error" id="cpfError"></span>
            </div>

            <div class="form-group">
              <label for="birthDate" class="form-label"
                >Data de Nascimento</label
              >
              <div class="input-wrapper">
                <i class="fas fa-calendar-alt icon-input"></i>
                <input
                  type="date"
                  id="birthDate"
                  class="form-input"
                  aria-label="Data de Nascimento"
                  required
                />
              </div>
              <span class="form-error" id="birthDateError"></span>
            </div>

            <button
              type="submit"
              class="btn-register-submit"
              data-action="register-user"
            >
              <i class="fas fa-user-plus"></i> Cadastrar
            </button>

            <div class="divider">OU</div>

            <button
              type="button"
              class="btn-register"
              data-action="navigate-login"
            >
              <i class="fas fa-sign-in-alt"></i> Voltar ao Login
            </button>
          </form>
        </div>
      </div>

      <!-- Se√ß√£o de Contatos -->
      <div class="contatos-section">
        <p class="contatos-title">Onde nos encontrar</p>
        <div class="contatos">
          <a
            href="https://www.instagram.com/barataoassados/"
            target="_blank"
            rel="noopener"
            class="social-link instagram"
            aria-label="Instagram"
          >
            <i class="fab fa-instagram"></i>
            <span>Instagram</span>
          </a>
          <a
            href="https://wa.me/5500000000000"
            target="_blank"
            rel="noopener"
            class="social-link whatsapp"
            aria-label="WhatsApp"
          >
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp</span>
          </a>
          <a
            href="https://wa.me/5500000000000"
            target="_blank"
            rel="noopener"
            class="social-link location"
            aria-label="Localiza√ß√£o"
          >
            <i class="fas fa-map-marker-alt"></i>
            <span>Localiza√ß√£o</span>
          </a>
        </div>
      </div>
    </section>

    <!-- √Årea de notifica√ß√µes -->
    <div
      id="notificationArea"
      class="notification-area"
      aria-live="polite"
    ></div>

    <script>
      /**
       * Sistema de Cadastro de Clientes - Barat√£o Assados
       * Arquitetura: Module Pattern + IIFE
       * Desenvolvido com ES6+ e princ√≠pios SOLID
       */

      "use strict";

      // ==================== M√ìDULO DE DADOS ====================
      const DataModule = (() => {
        const USER_STORAGE_KEY = "barataoAssadosUsers";

        /**
         * Obt√©m todos os usu√°rios cadastrados do localStorage.
         * @returns {Array<Object>} Array de objetos de usu√°rio.
         */
        const getUsers = () => {
          try {
            const users = localStorage.getItem(USER_STORAGE_KEY);
            return users ? JSON.parse(users) : [];
          } catch (e) {
            console.error("Erro ao ler usu√°rios do localStorage:", e);
            return [];
          }
        };

        /**
         * Salva um novo usu√°rio no localStorage.
         * @param {Object} newUser - Objeto do novo usu√°rio.
         * @returns {boolean} True se o usu√°rio foi salvo com sucesso, false caso contr√°rio.
         */
        const saveUser = (newUser) => {
          const users = getUsers();
          users.push(newUser);
          try {
            localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(users));
            return true;
          } catch (e) {
            console.error("Erro ao salvar usu√°rio no localStorage:", e);
            return false;
          }
        };

        /**
         * Verifica se um usu√°rio com o CPF fornecido j√° existe.
         * @param {string} cpf - CPF a ser verificado.
         * @returns {boolean} True se o usu√°rio existe, false caso contr√°rio.
         */
        const userExists = (cpf) => {
          const users = getUsers();
          return users.some((user) => user.cpf === cpf);
        };

        return {
          getUsers,
          saveUser,
          userExists,
        };
      })();

      // ==================== M√ìDULO DE UTILIT√ÅRIOS ====================
      const UtilsModule = (() => {
        /**
         * Formata um valor num√©rico para o formato de moeda brasileira.
         * @param {number} value - O valor a ser formatado.
         * @returns {string} O valor formatado (ex: "R$ 10,50").
         */
        const formatCurrency = (value) =>
          `R$ ${value.toFixed(2).replace(".", ",")}`;

        /**
         * Formata a hora atual para o padr√£o brasileiro.
         * @param {Date} [date=new Date()] - Objeto Date a ser formatado.
         * @returns {string} A hora formatada (ex: "14:30").
         */
        const formatTime = (date = new Date()) =>
          date.toLocaleTimeString("pt-BR", {
            hour: "2-digit",
            minute: "2-digit",
          });

        /**
         * Sanitiza uma string para prevenir ataques XSS (Cross-Site Scripting).
         * @param {string} text - O texto a ser sanitizado.
         * @returns {string} O texto sanitizado.
         */
        const sanitizeText = (text) => {
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        };

        /**
         * Retorna o primeiro elemento do DOM que corresponde ao seletor CSS.
         * @param {string} selector - O seletor CSS.
         * @returns {Element|null} O elemento encontrado ou null.
         */
        const getElement = (selector) => document.querySelector(selector);

        /**
         * Retorna todos os elementos do DOM que correspondem ao seletor CSS.
         * @param {string} selector - O seletor CSS.
         * @returns {NodeListOf<Element>} Uma NodeList de elementos.
         */
        const getAllElements = (selector) =>
          document.querySelectorAll(selector);

        /**
         * Cria um elemento DOM com atributos e conte√∫do.
         * @param {string} tag - A tag HTML do elemento (ex: 'div', 'button').
         * @param {Object} [attributes={}] - Um objeto com os atributos a serem definidos.
         * @param {string} [content=''] - O conte√∫do HTML interno do elemento.
         * @returns {Element} O elemento DOM criado.
         */
        const createElement = (tag, attributes = {}, content = "") => {
          const element = document.createElement(tag);

          Object.entries(attributes).forEach(([key, value]) => {
            if (key === "className") {
              element.className = value;
            } else if (key === "dataset") {
              Object.entries(value).forEach(([dataKey, dataValue]) => {
                element.dataset[dataKey] = dataValue;
              });
            } else {
              element.setAttribute(key, value);
            }
          });

          if (content) {
            element.innerHTML = content;
          }

          return element;
        };

        /**
         * Formata um CPF (apenas n√∫meros) para o padr√£o XXX.XXX.XXX-XX.
         * @param {string} cpf - O CPF a ser formatado.
         * @returns {string} O CPF formatado.
         */
        const formatCPF = (cpf) => {
          cpf = cpf.replace(/\D/g, ""); // Remove tudo que n√£o for d√≠gito
          if (cpf.length > 11) cpf = cpf.substring(0, 11); // Limita a 11 d√≠gitos
          cpf = cpf.replace(/(\d{3})(\d)/, "$1.$2");
          cpf = cpf.replace(/(\d{3})(\d)/, "$1.$2");
          cpf = cpf.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
          return cpf;
        };

        return {
          formatCurrency,
          formatTime,
          sanitizeText,
          getElement,
          getAllElements,
          createElement,
          formatCPF,
        };
      })();

      // ==================== M√ìDULO DE NOTIFICA√á√ïES ====================
      const NotificationModule = (() => {
        const NOTIFICATION_TYPES = {
          SUCCESS: "success",
          ERROR: "error",
          INFO: "info",
          WARNING: "warning",
        };

        /**
         * Exibe uma notifica√ß√£o tempor√°ria na tela.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} [type=NOTIFICATION_TYPES.INFO] - O tipo da notifica√ß√£o (success, error, info, warning).
         * @param {number} [duration=3000] - A dura√ß√£o da notifica√ß√£o em milissegundos.
         */
        const show = (
          message,
          type = NOTIFICATION_TYPES.INFO,
          duration = 3000
        ) => {
          const notificationArea = UtilsModule.getElement("#notificationArea");
          if (!notificationArea) return;

          const notification = UtilsModule.createElement(
            "div",
            {
              className: `notification notification--${type}`,
              "aria-live": "polite", // Anuncia para leitores de tela
            },
            `
            <div class="notification__content">
                <i class="notification__icon ${getIconForType(type)}"></i>
                <span class="notification__message">${UtilsModule.sanitizeText(
                  message
                )}</span>
            </div>
        `
          );

          notificationArea.appendChild(notification);

          setTimeout(() => {
            notification.classList.add("notification--removing"); // Adiciona classe para anima√ß√£o de sa√≠da
            setTimeout(() => notification.remove(), 300); // Remove o elemento ap√≥s a anima√ß√£o
          }, duration);
        };

        /**
         * Retorna a classe de √≠cone Font Awesome apropriada para o tipo de notifica√ß√£o.
         * @param {string} type - O tipo da notifica√ß√£o.
         * @returns {string} A classe CSS do √≠cone.
         */
        const getIconForType = (type) => {
          const icons = {
            [NOTIFICATION_TYPES.SUCCESS]: "fas fa-check-circle",
            [NOTIFICATION_TYPES.ERROR]: "fas fa-exclamation-circle",
            [NOTIFICATION_TYPES.INFO]: "fas fa-info-circle",
            [NOTIFICATION_TYPES.WARNING]: "fas fa-exclamation-triangle",
          };
          return icons[type] || icons[NOTIFICATION_TYPES.INFO];
        };

        return {
          show,
          success: (message, duration) =>
            show(message, NOTIFICATION_TYPES.SUCCESS, duration),
          error: (message, duration) =>
            show(message, NOTIFICATION_TYPES.ERROR, duration),
          info: (message, duration) =>
            show(message, NOTIFICATION_TYPES.INFO, duration),
          warning: (message, duration) =>
            show(message, NOTIFICATION_TYPES.WARNING, duration),
          TYPES: NOTIFICATION_TYPES,
        };
      })();

      // ==================== M√ìDULO DE VALIDA√á√ÉO ====================
      const ValidationModule = (() => {
        /**
         * Exibe uma mensagem de erro para um campo espec√≠fico.
         * @param {HTMLElement} inputElement - O elemento input.
         * @param {string} message - A mensagem de erro.
         */
        const showError = (inputElement, message) => {
          const errorElement = UtilsModule.getElement(
            `#${inputElement.id}Error`
          );
          if (errorElement) {
            errorElement.textContent = message;
            inputElement.classList.add("input-error");
          }
        };

        /**
         * Limpa a mensagem de erro para um campo espec√≠fico.
         * @param {HTMLElement} inputElement - O elemento input.
         */
        const clearError = (inputElement) => {
          const errorElement = UtilsModule.getElement(
            `#${inputElement.id}Error`
          );
          if (errorElement) {
            errorElement.textContent = "";
            inputElement.classList.remove("input-error");
          }
        };

        /**
         * Valida o nome completo.
         * @param {string} name - Nome completo.
         * @returns {string|null} Mensagem de erro ou null se v√°lido.
         */
        const validateFullName = (name) => {
          if (!name || name.trim().length < 3) {
            return "Nome completo deve ter pelo menos 3 caracteres.";
          }
          return null;
        };

        /**
         * Valida o endere√ßo.
         * @param {string} address - Endere√ßo.
         * @returns {string|null} Mensagem de erro ou null se v√°lido.
         */
        const validateAddress = (address) => {
          if (!address || address.trim().length < 5) {
            return "Endere√ßo deve ter pelo menos 5 caracteres.";
          }
          return null;
        };

        /**
         * Valida um CPF.
         * @param {string} cpf - O CPF a ser validado (pode estar formatado ou n√£o).
         * @returns {string|null} Mensagem de erro ou null se v√°lido.
         */
        const validateCPF = (cpf) => {
          cpf = cpf.replace(/\D/g, ""); // Remove caracteres n√£o num√©ricos

          if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
            return "CPF inv√°lido.";
          }

          let sum = 0;
          let remainder;

          for (let i = 1; i <= 9; i++) {
            sum = sum + parseInt(cpf.substring(i - 1, i)) * (11 - i);
          }
          remainder = (sum * 10) % 11;

          if (remainder === 10 || remainder === 11) remainder = 0;
          if (remainder !== parseInt(cpf.substring(9, 10))) {
            return "CPF inv√°lido.";
          }

          sum = 0;
          for (let i = 1; i <= 10; i++) {
            sum = sum + parseInt(cpf.substring(i - 1, i)) * (12 - i);
          }
          remainder = (sum * 10) % 11;

          if (remainder === 10 || remainder === 11) remainder = 0;
          if (remainder !== parseInt(cpf.substring(10, 11))) {
            return "CPF inv√°lido.";
          }

          return null; // CPF v√°lido
        };

        /**
         * Valida a data de nascimento.
         * @param {string} birthDateString - Data de nascimento no formato YYYY-MM-DD.
         * @returns {string|null} Mensagem de erro ou null se v√°lido.
         */
        const validateBirthDate = (birthDateString) => {
          if (!birthDateString) {
            return "Data de nascimento √© obrigat√≥ria.";
          }
          const birthDate = new Date(birthDateString + "T00:00:00"); // Adiciona T00:00:00 para evitar problemas de fuso hor√°rio
          const today = new Date();
          today.setHours(0, 0, 0, 0); // Zera a hora para comparar apenas a data

          if (birthDate > today) {
            return "Data de nascimento n√£o pode ser no futuro.";
          }
          return null;
        };

        return {
          showError,
          clearError,
          validateFullName,
          validateAddress,
          validateCPF,
          validateBirthDate,
        };
      })();

      // ==================== M√ìDULO PRINCIPAL (APP) ====================
      const App = (() => {
        const fullNameInput = UtilsModule.getElement("#fullName");
        const addressInput = UtilsModule.getElement("#address");
        const cpfInput = UtilsModule.getElement("#cpf");
        const birthDateInput = UtilsModule.getElement("#birthDate");
        const registerForm = UtilsModule.getElement("#registerForm");

        /**
         * Gerencia o envio do formul√°rio de registro.
         * @param {Event} event - O evento de submiss√£o.
         */
        const handleRegisterSubmit = (event) => {
          event.preventDefault(); // Previne o recarregamento da p√°gina

          // Limpa erros anteriores
          ValidationModule.clearError(fullNameInput);
          ValidationModule.clearError(addressInput);
          ValidationModule.clearError(cpfInput);
          ValidationModule.clearError(birthDateInput);

          let isValid = true;

          // Valida Nome Completo
          const fullNameError = ValidationModule.validateFullName(
            fullNameInput.value
          );
          if (fullNameError) {
            ValidationModule.showError(fullNameInput, fullNameError);
            isValid = false;
          }

          // Valida Endere√ßo
          const addressError = ValidationModule.validateAddress(
            addressInput.value
          );
          if (addressError) {
            ValidationModule.showError(addressInput, addressError);
            isValid = false;
          }

          // Valida CPF
          const cpfError = ValidationModule.validateCPF(cpfInput.value);
          if (cpfError) {
            ValidationModule.showError(cpfInput, cpfError);
            isValid = false;
          } else if (DataModule.userExists(cpfInput.value)) {
            ValidationModule.showError(cpfInput, "CPF j√° cadastrado.");
            isValid = false;
          }

          // Valida Data de Nascimento
          const birthDateError = ValidationModule.validateBirthDate(
            birthDateInput.value
          );
          if (birthDateError) {
            ValidationModule.showError(birthDateInput, birthDateError);
            isValid = false;
          }

          if (isValid) {
            const newUser = {
              nomeCompleto: fullNameInput.value,
              endereco: addressInput.value,
              cpf: cpfInput.value,
              dataNascimento: birthDateInput.value,
              // Para fins de login, o CPF ser√° a senha
              senha: cpfInput.value,
            };

            if (DataModule.saveUser(newUser)) {
              NotificationModule.success(
                "Cadastro realizado com sucesso! Redirecionando para o login..."
              );
              setTimeout(() => {
                window.location.href = "login.html";
              }, 2000);
            } else {
              NotificationModule.error(
                "Erro ao salvar cadastro. Tente novamente."
              );
            }
          } else {
            NotificationModule.error(
              "Por favor, corrija os erros no formul√°rio."
            );
          }
        };

        /**
         * Formata o CPF enquanto o usu√°rio digita.
         * @param {Event} event - O evento de input.
         */
        const handleCPFInput = (event) => {
          event.target.value = UtilsModule.formatCPF(event.target.value);
          ValidationModule.clearError(event.target); // Limpa erro ao digitar
        };

        /**
         * Redireciona para a p√°gina de login.
         */
        const handleBackToLogin = () => {
          window.location.href = "login.html";
        };

        /**
         * Inicializa a aplica√ß√£o, configurando os listeners de eventos.
         */
        const init = () => {
          document.addEventListener("DOMContentLoaded", () => {
            try {
              registerForm.addEventListener("submit", handleRegisterSubmit);
              cpfInput.addEventListener("input", handleCPFInput);

              // Limpa erros ao focar/digitar em outros campos
              fullNameInput.addEventListener("input", () =>
                ValidationModule.clearError(fullNameInput)
              );
              addressInput.addEventListener("input", () =>
                ValidationModule.clearError(addressInput)
              );
              birthDateInput.addEventListener("change", () =>
                ValidationModule.clearError(birthDateInput)
              );

              // Listener para o bot√£o "Voltar ao Login"
              const backToLoginBtn = UtilsModule.getElement(
                '[data-action="navigate-login"]'
              );
              if (backToLoginBtn) {
                backToLoginBtn.addEventListener("click", handleBackToLogin);
              }

              // Listener para o bot√£o "Voltar" no header
              const headerBackBtn = UtilsModule.getElement(
                '[data-action="navigate-back"]'
              );
              if (headerBackBtn) {
                headerBackBtn.addEventListener("click", handleBackToLogin);
              }

              NotificationModule.info("Bem-vindo(a) ao cadastro!", 2000);
              console.log("üöÄ Sistema de Cadastro inicializado com sucesso!");
            } catch (error) {
              console.error("‚ùå Erro na inicializa√ß√£o do cadastro:", error);
              NotificationModule.error(
                "N√£o foi poss√≠vel carregar a p√°gina de cadastro."
              );
            }
          });
        };

        return { init };
      })();

      // Inicia a aplica√ß√£o
      App.init();
    </script>
  </body>
</html>
